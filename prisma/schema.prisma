// Prisma Schema for Puzzel Co-Work
// Core RBAC model with audit logging

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & RBAC
// ============================================================================

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  name         String?
  authProvider AuthProvider @default(LOCAL)
  externalId   String? // Azure AD object ID (for future SSO)
  passwordHash String? // Only for local auth
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  roles                  UserRole[]
  auditLogs              AuditLog[]
  organizationMemberships OrganizationUser[]
  coworkSessions         CoworkSession[]
  coworkSkillsCreated    CoworkSkill[]

  @@map("users")
}

enum AuthProvider {
  LOCAL
  AZURE
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // admin, viewer
  description String?
  isSystem    Boolean  @default(false) // true for global roles (admin, viewer)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // users:read, users:admin, audit:read
  description String?
  createdAt   DateTime @default(now())

  // Relations
  roles                RolePermission[]
  organizationRoles    OrganizationRolePermission[]

  @@map("permissions")
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================================================
// ORGANIZATIONS
// ============================================================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL-friendly identifier
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     OrganizationUser[]
  roles       OrganizationRole[]
  auditLogs   AuditLog[]
  coworkSessions CoworkSession[]
  coworkSettings CoworkSettings?
  coworkSkills   CoworkSkill[]

  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}

model OrganizationUser {
  userId         String
  organizationId String
  roleId         String? // Organization-specific role
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         OrganizationRole? @relation(fields: [roleId], references: [id])

  @@id([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_users")
}

model OrganizationRole {
  id             String   @id @default(cuid())
  organizationId String
  name           String   // e.g., "admin", "member", "viewer"
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users            OrganizationUser[]
  rolePermissions  OrganizationRolePermission[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("organization_roles")
}

model OrganizationRolePermission {
  roleId       String
  permissionId String

  role       OrganizationRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission       @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("organization_role_permissions")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id             String       @id @default(cuid())
  action         String // e.g., "user.created", "auth.login"
  resourceType   String // e.g., "user", "auth"
  resourceId     String
  userId         String
  organizationId String? // Nullable for system-level audits
  details        Json? // Additional metadata
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime     @default(now())

  user         User         @relation(fields: [userId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// COWORK - AI Agent Sessions
// ============================================================================

model CoworkSession {
  id             String              @id @default(cuid())
  userId         String
  organizationId String
  title          String              @default("New Task")
  status         CoworkSessionStatus @default(ACTIVE)
  model          String              @default("claude-sonnet-4-5")
  systemPrompt   String?             @db.Text
  planMode       Boolean             @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     CoworkMessage[]
  todos        CoworkTodoItem[]
  files        CoworkFile[]
  subAgents    CoworkSubAgent[]
  skills       CoworkSkill[]
  permissionRequests CoworkPermissionRequest[]
  messageFeedback CoworkMessageFeedback[]

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([updatedAt])
  @@map("cowork_sessions")
}

enum CoworkSessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ERROR
}

model CoworkMessage {
  id        String            @id @default(cuid())
  sessionId String
  role      CoworkMessageRole
  content   Json              // Array of MessageContent blocks
  metadata  Json?             // tokenUsage, toolCalls, subAgentId
  createdAt DateTime          @default(now())

  session  CoworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  feedback CoworkMessageFeedback[]

  @@index([sessionId])
  @@index([createdAt])
  @@map("cowork_messages")
}

model CoworkMessageFeedback {
  id             String   @id @default(cuid())
  messageId      String
  sessionId      String
  userId         String
  organizationId String
  rating         String   // "positive" | "negative"
  comment        String?  @db.Text
  metadata       Json?    // browser info, etc.
  createdAt      DateTime @default(now())

  message CoworkMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  session CoworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([sessionId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("cowork_message_feedback")
}

enum CoworkMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model CoworkTodoItem {
  id         String           @id @default(cuid())
  sessionId  String
  content    String           // Imperative form: "Run tests"
  activeForm String           // Present continuous: "Running tests"
  status     CoworkTodoStatus @default(PENDING)
  sortOrder  Int              @default(0)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  session CoworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("cowork_todo_items")
}

enum CoworkPermissionRequestStatus {
  pending
  approved
  denied
  timeout
}

model CoworkPermissionRequest {
  id         String                        @id @default(cuid())
  sessionId  String
  requestId  String                        // perm_<toolCallId>_<timestamp>
  toolName   String
  toolInput  Json                          // Tool input for display/audit
  status     CoworkPermissionRequestStatus @default(pending)
  createdAt  DateTime                      @default(now())
  resolvedAt DateTime?

  session CoworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, requestId])
  @@index([sessionId])
  @@index([requestId])
  @@map("cowork_permission_requests")
}

enum CoworkTodoStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model CoworkFile {
  id          String             @id @default(cuid())
  sessionId   String
  fileName    String
  mimeType    String
  sizeBytes   Int
  category    CoworkFileCategory
  storagePath String
  downloadUrl String
  metadata    Json?              // originalName, generatedBy, artifactType
  createdAt   DateTime           @default(now())

  session CoworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([category])
  @@map("cowork_files")
}

enum CoworkFileCategory {
  UPLOAD
  OUTPUT
  WORKING
}

model CoworkSettings {
  id             String @id @default(cuid())
  organizationId String @unique
  defaultProvider String @default("anthropic") // 'anthropic' | 'openai'
  defaultModel    String @default("claude-sonnet-4-20250514")
  temperature     Float  @default(0.7)
  maxTokens       Int    @default(4096)
  systemPrompt    String? @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("cowork_settings")
}

model CoworkSubAgent {
  id             String            @id @default(cuid())
  sessionId      String
  description    String
  type           CoworkSubAgentType @default(GENERAL_PURPOSE)
  status         CoworkSubAgentStatus @default(RUNNING)
  prompt         String            @db.Text
  result         String?           @db.Text
  model          String?
  turns          Int               @default(0)
  maxTurns       Int               @default(10)
  createdAt      DateTime          @default(now())
  completedAt    DateTime?

  session CoworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
  @@map("cowork_sub_agents")
}

enum CoworkSubAgentType {
  BASH
  GENERAL_PURPOSE
  EXPLORE
  PLAN
}

enum CoworkSubAgentStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum CoworkSkillStatus {
  draft
  published
}

model CoworkSkill {
  id             String   @id @default(cuid())
  organizationId String
  sessionId      String?  // null = org-wide, set = session-scoped
  name           String
  description    String   @db.Text
  category       String   @default("General")
  triggers       Json     // string[]
  tags           Json     @default("[]") // string[] for search
  content        String   @db.Text
  parameters     Json     @default("[]") // SkillParameter[]
  exampleInput   String?  @db.Text
  exampleOutput  String?  @db.Text
  version        Int      @default(1)
  status         CoworkSkillStatus @default(draft)
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  session      CoworkSession?  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdBy    User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([sessionId])
  @@index([organizationId, sessionId])
  @@index([organizationId, category])
  @@map("cowork_skills")
}
